<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial scale=1.0" />
    <title>Sign In</title>
</head>

<body>
    <div id="sign-in-con">
        <h2>Sign In</h2>

        <form id="sign-in-form">
            <input type="email" id="email" placeholder="Email" required><br><br>
            <input type="password" id="sign-in-password" placeholder="Password" required><br><br>
            <input type="submit" value="Sign In">
        </form><br><br>

        <button onclick="resetPassword()">Reset Password</button><br><br>

        Not yet registered? <b onclick="switchToCon('sign-up-con')">Sign up</b>

        <p id="authMessage"></p>
    </div>

    <div id="sign-up-con" style="display: none;">
        <h2>Sign Up</h2>
        <form id="sign-up-form">
            <input type="email" id="email" placeholder="Email" required><br><br>
            <input type="password" id="sign-up-password" placeholder="Password" required><br><br>
            <input type="submit" value="Sign Up">
        </form><br><br>

        <!-- <button onclick="checkPasswordLength();">Sign Up</button> -->
        Already registered? <b onclick="switchToCon('sign-in-con')">Sign In</b>

        <p id="authMessage"></p>
    </div>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = "https://rnjzrgcxoixnmcrrbxrq.supabase.co";
        const supabaseKey = "sb_publishable_aLO42mHvFv6-u1Tj2fTx5g_6agj3rir";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const msg = document.getElementById("authMessage");

        //sign up function
        async function signUp() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("sign-up-password").value;

            const { data, error } = await supabaseClient
                .from("allowed_emails")
                .select("email")
                .eq("email", email)
                .single();

            if (error || !data) {
                alert("This email is not authorized.");
                return;
            }

            const { error: signUpError } =
                await supabaseClient.auth.signUp({ email, password });

            if (signUpError) {
                alert(signUpError.message);
            } else {
                alert("Signup successful.\nPlease log in with your email and password.");
                switchToCon("sign-in-con");
            }
        }

        //sign in function
        async function signIn() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("sign-in-password").value;

            const { error } = await supabaseClient.auth.signInWithPassword({
                email, password
            });

            if (!error) {
                window.location.href = "user-data.html";
            } else {
                alert(error.message);
            }
        }


        //switches between the sign-in and sign-up containers
        let currentConName = "sign-in-con";
        function switchToCon(conName) {
            document.getElementById(currentConName).style.display = "none";
            document.getElementById(conName).style.display = "block";
            currentConName = conName;
        }

        //selects the sign-in form
        const signInForm = document.getElementById("sign-in-form");
        signInForm.addEventListener("submit", (e) => {
            e.preventDefault();
            signIn();
        });

        //selects the sign-up form
        const signUpForm = document.getElementById("sign-up-form");
        signUpForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const password = document.getElementById("sign-up-password").value;
            checkPasswordLength(password);
        });

        //checks the length of the password
        function checkPasswordLength(password) {
            if (password.length < 6) {
                alert("Password must be 6 or more characters long.\nPlease increase password length.");
                return;
            } else if (password == "123456") {
                alert("Password is weak.\nPlease choose a stronger password.");
                return;
            }
            signUp();
        }

    </script>
</body>

</html>